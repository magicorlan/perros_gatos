<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Deteci√≥n de perros y gatos</title>
  </head>
  <body>
    <video id="video" width="640" height="480" autoplay></video>
    <canvas id="canvas" width="640" height="480"></canvas>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <script>
      async function loadModel() {
        const model = await tf.loadGraphModel('model.json');
        return model;
      }

      async function detectObjects(model, video) {
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');

        const canvasWidth = canvas.width;
        const canvasHeight = canvas.height;

        const resized = tf.image.resizeBilinear(tf.browser.fromPixels(video), [224, 224]);
        const normalized = resized.toFloat().sub(255 / 2).div(255 / 2);

        const output = await model.predict(normalized.reshape([-1, 224, 224, 3]));

        const labels = Array.from(output.argMax(axis=1).dataSync());
        const probabilities = Array.from(output.dataSync());

        for (let i = 0; i < labels.length; i++) {
          if (labels[i] === 0) {
            context.strokeStyle = 'red';
            context.fillStyle = 'red';
            context.fillText('Perro', 10, 50);
          } else if (labels[i] === 1) {
            context.strokeStyle = 'green';
            context.fillStyle = 'green';
            context.fillText('Gato', 10, 50);
          }

          const [y, x, height, width] = Array.from(await output.slice([i, 0], [1, 4]).array());
          const startX = x * canvasWidth;
          const startY = y * canvasHeight;
          const endX = startX + (width * canvasWidth);
          const endY = startY + (height * canvasHeight);

          context.beginPath();
          context.rect(startX, startY, endX - startX, endY - startY);
          context.stroke();
          context.closePath();
        }

        resized.dispose();
        normalized.dispose();
        output.dispose();
      }

      async function main() {
        const model = await loadModel();

        const video = document.getElementById('video');
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
          const stream = await navigator.mediaDevices.getUserMedia({video: true});
          video.srcObject = stream;
          video.play();
        }

        setInterval(() => detectObjects(model, video), 1000);
      }

      main();
    </script>
  </body>
</html>
